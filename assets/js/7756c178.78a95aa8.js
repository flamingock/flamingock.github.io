"use strict";(self.webpackChunkflamingock=self.webpackChunkflamingock||[]).push([[8633],{783:(e,n,i)=>{i.r(n),i.d(n,{assets:()=>l,contentTitle:()=>c,default:()=>h,frontMatter:()=>r,metadata:()=>s,toc:()=>o});const s=JSON.parse('{"id":"flamingock-library-config/changeunits-deep-dive","title":"ChangeUnits Deep Dive","description":"Clarifying changeUnits","source":"@site/docs/flamingock-library-config/changeunits-deep-dive.md","sourceDirName":"flamingock-library-config","slug":"/flamingock-library-config/changeunits-deep-dive","permalink":"/docs/1.0.0/flamingock-library-config/changeunits-deep-dive","draft":false,"unlisted":false,"editUrl":"https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/flamingock-library-config/changeunits-deep-dive.md","tags":[],"version":"current","sidebarPosition":3,"frontMatter":{"title":"ChangeUnits Deep Dive","sidebar_position":3},"sidebar":"tutorialSidebar","previous":{"title":"Setup & Stages","permalink":"/docs/1.0.0/flamingock-library-config/setup-and-stages"},"next":{"title":"ChangeUnit dependency injection","permalink":"/docs/1.0.0/flamingock-library-config/changeunit-dependency-injection"}}');var t=i(4848),a=i(8453);const r={title:"ChangeUnits Deep Dive",sidebar_position:3},c=void 0,l={},o=[{value:"Clarifying changeUnits",id:"clarifying-changeunits",level:2},{value:"What a changeUnit Is",id:"what-a-changeunit-is",level:3},{value:"What a changeUnit is not",id:"what-a-changeunit-is-not",level:3},{value:"ChangeUnit properties",id:"changeunit-properties",level:2},{value:"Types of changeUnits",id:"types-of-changeunits",level:2},{value:"Code-based changeUnits",id:"code-based-changeunits",level:3},{value:"Discoverability &amp; execution",id:"discoverability--execution",level:4},{value:"Template-based changeUnits",id:"template-based-changeunits",level:3},{value:"Discoverability &amp; execution",id:"discoverability--execution-1",level:4},{value:"Considerations",id:"considerations",level:2},{value:"Transactional behavior",id:"transactional-behavior",level:3},{value:"Immutability",id:"immutability",level:3},{value:"Audit store constraints",id:"audit-store-constraints",level:3},{value:"Idempotency",id:"idempotency",level:3},{value:"Best practices",id:"best-practices",level:2}];function d(e){const n={a:"a",br:"br",code:"code",h2:"h2",h3:"h3",h4:"h4",hr:"hr",li:"li",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,a.R)(),...e.components};return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(n.h2,{id:"clarifying-changeunits",children:"Clarifying changeUnits"}),"\n",(0,t.jsxs)(n.p,{children:["A ",(0,t.jsx)(n.strong,{children:"ChangeUnit"})," is the atomic, versioned unit of change in Flamingock. It encapsulates logic to modify an external system (the ",(0,t.jsx)(n.a,{href:"/docs/1.0.0/overview/audit-store-vs-target-system",children:(0,t.jsx)(n.strong,{children:"target system"})}),") and provides metadata and rollback capability. ChangeUnits are discovered and executed in a defined order to ensure deterministic, auditable changes."]}),"\n",(0,t.jsx)(n.h3,{id:"what-a-changeunit-is",children:"What a changeUnit Is"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.strong,{children:"Self-contained change"}),(0,t.jsx)(n.br,{}),"\n","Each ChangeUnit includes:"]}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:["A unique ",(0,t.jsx)(n.code,{children:"id"})," (unique across the entire application)"]}),"\n",(0,t.jsxs)(n.li,{children:["An ",(0,t.jsx)(n.code,{children:"order"})," determining execution sequence"]}),"\n",(0,t.jsxs)(n.li,{children:["An optional ",(0,t.jsx)(n.code,{children:"author"})," and ",(0,t.jsx)(n.code,{children:"description"})]}),"\n",(0,t.jsxs)(n.li,{children:["An ",(0,t.jsx)(n.code,{children:"@Execution"})," method (or template) with the change logic"]}),"\n",(0,t.jsxs)(n.li,{children:["A ",(0,t.jsx)(n.code,{children:"@RollbackExecution"})," method (or template) with compensating logic"]}),"\n",(0,t.jsxs)(n.li,{children:["A ",(0,t.jsx)(n.code,{children:"transactional"})," flag (default ",(0,t.jsx)(n.code,{children:"true"}),") indicating if Flamingock will attempt to wrap execution and audit in a single transaction"]}),"\n"]}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.strong,{children:"Versioned and Auditable"}),(0,t.jsx)(n.br,{}),"\n","ChangeUnits live in your source code or resources, and their execution is recorded in the ",(0,t.jsx)(n.a,{href:"/docs/1.0.0/overview/audit-store-vs-target-system",children:(0,t.jsx)(n.strong,{children:"audit store"})})," to:"]}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"Prevent duplicate executions"}),"\n",(0,t.jsx)(n.li,{children:"Track history (who ran which change and when)"}),"\n",(0,t.jsx)(n.li,{children:"Drive rollbacks and \u201cundo\u201d operations"}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,t.jsx)(n.h3,{id:"what-a-changeunit-is-not",children:"What a changeUnit is not"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"Not a long-running job"}),(0,t.jsx)(n.br,{}),"\n","ChangeUnits should complete promptly. Flamingock needs to know the result (success or failure) before proceeding. Long-running or asynchronous operations can lead to unexpected behavior or retries."]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"Not a general-purpose script"}),(0,t.jsx)(n.br,{}),"\n","While ChangeUnits run code, they are not intended for arbitrary scripting. Their role is to apply deterministic, idempotent changes that evolve your target systems in sync with your application."]}),"\n"]}),"\n",(0,t.jsx)(n.hr,{}),"\n",(0,t.jsx)(n.h2,{id:"changeunit-properties",children:"ChangeUnit properties"}),"\n",(0,t.jsx)(n.p,{children:"Every ChangeUnit must define:"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.code,{children:"id"})," (String): Unique across all ChangeUnits in the application."]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.code,{children:"order"})," (String or numeric): Defines execution order (evaluated lexicographically or numerically)."]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.code,{children:"author"})," (String): Who is responsible for the change."]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.code,{children:"description"})," (String, optional): Brief explanation of the change."]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.code,{children:"transactional"})," (boolean, default ",(0,t.jsx)(n.code,{children:"true"}),"): Whether Flamingock will attempt to wrap the change and audit insert in one transaction (if the target system and audit store support transactions)."]}),"\n"]}),"\n",(0,t.jsx)(n.hr,{}),"\n",(0,t.jsx)(n.h2,{id:"types-of-changeunits",children:"Types of changeUnits"}),"\n",(0,t.jsxs)(n.p,{children:["ChangeUnits can be defined based on two approaches: code-based and ",(0,t.jsx)(n.a,{href:"/docs/1.0.0/templates/templates-introduction",children:"template-based"})]}),"\n",(0,t.jsx)(n.h3,{id:"code-based-changeunits",children:"Code-based changeUnits"}),"\n",(0,t.jsx)(n.p,{children:"Code-based ChangeUnits are written in Java (or Kotlin/Groovy) with annotations:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-java",children:'@ChangeUnit(\n        id = "create_s3_bucket", \n        order = "0001", \n        author = "dev-team", \n        transactional = false,\n        description = "Create my-app-bucket S3 bucket")\npublic class _0001_CreateS3BucketChange {\n\n  @Execution\n  public void execute(S3Client s3Client) {\n    s3Client.createBucket("my-app-bucket");\n  }\n\n  @RollbackExecution\n  public void rollback(S3Client s3Client) {\n    s3Client.deleteBucket("my-app-bucket");\n  }\n}\n'})}),"\n",(0,t.jsx)(n.h4,{id:"discoverability--execution",children:"Discoverability & execution"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"Location"}),": Files must reside in a source package scanned by Flamingock (default: ",(0,t.jsx)(n.code,{children:"src/main/java"}),")."]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"Naming"}),": Class names should match ",(0,t.jsx)(n.code,{children:"_ORDER_name"})," (e.g., ",(0,t.jsx)(n.code,{children:"_0001_CreateS3BucketChange"}),") to simplify ordering and visibility."]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"Dependencies"}),": Flamingock injects dependencies (e.g., ",(0,t.jsx)(n.code,{children:"S3Client"}),", ",(0,t.jsx)(n.code,{children:"MongoClient"}),") via Spring or builder-based DI."]}),"\n"]}),"\n",(0,t.jsx)(n.h3,{id:"template-based-changeunits",children:"Template-based changeUnits"}),"\n",(0,t.jsx)(n.p,{children:"Template-based ChangeUnits use YAML or JSON definitions. Example (SQL DDL):"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-yaml",children:"# /src/main/resources/_0003_add_status_column.yml\nid: add_status_column\norder: 0003\nauthor: \"db-team\"\ndescription: \"Add 'status' column to 'orders' table\"\ntemplateName: sql-template\ntemplateConfiguration:\n  executionSql: |\n    ALTER TABLE orders ADD COLUMN status VARCHAR(20);\n  rollbackSql: |\n    ALTER TABLE orders DROP COLUMN status;\n"})}),"\n",(0,t.jsx)(n.h4,{id:"discoverability--execution-1",children:"Discoverability & execution"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"Location"}),": While Flamingock will scan src/main/resources by default, we ",(0,t.jsx)(n.strong,{children:"strongly recommend"})," placing template files in the same code\u2010package/directory as your code\u2010based ChangeUnits.","\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"This ensures that both code\u2010based and template\u2010based ChangeUnits live side by side for visibility and immutability."}),"\n"]}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"Naming"}),": File names should follow ",(0,t.jsx)(n.code,{children:"_ORDER_name.yml"})," or ",(0,t.jsx)(n.code,{children:"_ORDER_name.json"}),"."]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"Advantages"}),":","\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"Easier immutability: The YAML/JSON file itself represents the change, avoiding modifications in code."}),"\n",(0,t.jsx)(n.li,{children:"Better for simple, repeatable tasks (e.g., SQL DDL)."}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,t.jsx)(n.hr,{}),"\n",(0,t.jsx)(n.h2,{id:"considerations",children:"Considerations"}),"\n",(0,t.jsx)(n.h3,{id:"transactional-behavior",children:"Transactional behavior"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"Transactional changes (default)"}),": When the target system and audit store share a transactional context (e.g., MongoDB CE), Flamingock wraps both in a single transaction."]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"Non-transactional changes"}),": ",(0,t.jsx)(n.code,{children:"transactional = false"}),". Flamingock executes ",(0,t.jsx)(n.code,{children:"@Execution"})," and, upon success, writes to the audit store. If ",(0,t.jsx)(n.code,{children:"@Execution"})," fails, Flamingock invokes ",(0,t.jsx)(n.code,{children:"@RollbackExecution"}),". See ",(0,t.jsx)(n.a,{href:"/docs/1.0.0/flamingock-library-config/transactions",children:"transactions page"})]}),"\n"]}),"\n",(0,t.jsx)(n.h3,{id:"immutability",children:"Immutability"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"Code-based"}),": Once committed and possibly executed, avoid modifying the class. Instead, introduce a new ChangeUnit for evolution."]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"Template-based"}),": Treat the file as immutable. Modifying an existing template breaks history ordering \u2014 use new template files for new changes."]}),"\n"]}),"\n",(0,t.jsx)(n.h3,{id:"audit-store-constraints",children:"Audit store constraints"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"Single audit store per application"}),": All ChangeUnits in one application write to the same audit store."]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"Audit store integrity"}),": Do not manually modify audit records in the audit store; this can corrupt Flamingock\u2019s state. Use CLI/UI for supported modifications."]}),"\n"]}),"\n",(0,t.jsx)(n.h3,{id:"idempotency",children:"Idempotency"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"ChangeUnits should be idempotent or safe to re-run. Flamingock retries failed ChangeUnits on next startup. If a non-transactional ChangeUnit partially succeeded, ensure it can handle multiple executions or include appropriate guards."}),"\n"]}),"\n",(0,t.jsx)(n.hr,{}),"\n",(0,t.jsx)(n.h2,{id:"best-practices",children:"Best practices"}),"\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.strong,{children:"Name and location conventions"}),"*"]}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsx)(n.p,{children:"Place both code-based and template-based ChangeUnits in the same source package/directory for visibility and immutability."}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsxs)(n.p,{children:["Use filenames or class names prefixed with the zero-padded order (e.g., ",(0,t.jsx)(n.code,{children:"_0001_create_s3_bucket.java"})," or ",(0,t.jsx)(n.code,{children:"_0001_create_s3_bucket.yaml"}),")."]}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.strong,{children:"Always provide rollback"}),(0,t.jsx)(n.br,{}),"\n","Even for transactional ChangeUnits, implement ",(0,t.jsx)(n.code,{children:"@RollbackExecution"})," so CLI \u201cundo\u201d operations work smoothly."]}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.strong,{children:"Template-based changeUnits for simplicity and immutability"}),(0,t.jsx)(n.br,{}),"\n","Favor templated ChangeUnits (YAML/JSON) for routine, repeatable tasks\u2014such as SQL DDL, configuration toggles, or small API calls. Templates are inherently immutable (being a static file), making it easier to adhere to versioning best practices."]}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.strong,{children:"Use Flamingock\u2019s batching feature for long-running operations"}),"(coming soon)",(0,t.jsx)(n.br,{}),"\n","For ChangeUnits that process large workloads (e.g., migrating millions of rows), leverage Flamingock\u2019s built-in batching mechanism. Define a single ChangeUnit that iterates through data in batches; Flamingock will mark it as complete only when all batches succeed, and will resume from the last processed batch on retry."]}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.strong,{children:"Inject minimal dependencies"}),(0,t.jsx)(n.br,{}),"\n","Only inject what you need (e.g., clients, DAOs). Avoid injecting large application contexts within ChangeUnits."]}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.strong,{children:"Write clear descriptions"}),(0,t.jsx)(n.br,{}),"\n","Use the ",(0,t.jsx)(n.code,{children:"description"})," property to explain the purpose and impact of each ChangeUnit."]}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.strong,{children:"Implement idempotency"}),(0,t.jsx)(n.br,{}),"\n","For non-transactional operations (e.g., deleting an S3 bucket), wrap calls in checks (e.g., \u201cif exists\u201d) to handle re-runs gracefully."]}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.strong,{children:"Immutable operations"}),(0,t.jsx)(n.br,{}),"\n","Once a ChangeUnit is applied to any environment, treat its code or template as immutable. For corrections, create new ChangeUnits rather than editing old ones."]}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.strong,{children:"Explicit ordering"}),(0,t.jsx)(n.br,{}),"\n","Declare a clear, numeric ",(0,t.jsx)(n.code,{children:"order"})," for each ChangeUnit. Relying on implicit or alphabetical ordering can introduce hidden dependencies and make debugging deployment issues difficult."]}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.strong,{children:"Audit store hygiene"}),(0,t.jsx)(n.br,{}),"\n","Never manually edit or delete records in the audit store. Direct modifications can corrupt Flamingock\u2019s internal state and lead to unpredictable behavior or data loss. If you need to correct audit data, use Flamingock\u2019s supported operations (CLI or UI) or follow documented recovery procedures."]}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.strong,{children:"Documentation and metadata"}),(0,t.jsx)(n.br,{}),"\n","Use the ",(0,t.jsx)(n.code,{children:"author"})," and ",(0,t.jsx)(n.code,{children:"description"})," (if available) fields to document the intent of each ChangeUnit. This metadata helps teams understand why a change was made and by whom\u2014critical for code reviews and compliance audits."]}),"\n"]}),"\n"]})]})}function h(e={}){const{wrapper:n}={...(0,a.R)(),...e.components};return n?(0,t.jsx)(n,{...e,children:(0,t.jsx)(d,{...e})}):d(e)}},8453:(e,n,i)=>{i.d(n,{R:()=>r,x:()=>c});var s=i(6540);const t={},a=s.createContext(t);function r(e){const n=s.useContext(a);return s.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function c(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(t):e.components||t:r(e.components),s.createElement(a.Provider,{value:n},e.children)}}}]);